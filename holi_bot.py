import asyncio
import requests
import os
import threading
import http.server
import socketserver
from http.server import BaseHTTPRequestHandler, HTTPServer
from aiogram import Bot, Dispatcher, types, F
from aiogram.types import Message
from aiogram.filters import CommandStart
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.storage.memory import MemoryStorage
import json

TOKEN = "7809691512:AAHmFFAGkXu34oW3IujqoTcTmiwzs66Hwe0"
SERVER_URL = "https://server-for-holi.onrender.com/save_user"
MENU_URL = "https://t.me/holiarus_bot/Holiarus?start=menu"

bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

user_data = {}  # –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path.startswith("/get_user/"):
            user_id = self.path.split("/")[-1]
            if user_id in user_data:
                self.send_response(200)
                self.send_header("Content-type", "application/json")
                self.end_headers()
                self.wfile.write(json.dumps(user_data[user_id]).encode())
            else:
                self.send_response(404)
                self.end_headers()


def run_server():
    port = 8080
    server = HTTPServer(("", port), RequestHandler)
    print(f"–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    server.serve_forever()

threading.Thread(target=run_server, daemon=True).start()

def keep_alive():
    port = int(os.environ.get("PORT", 8080))
    handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", port), handler) as httpd:
        print(f"–§–µ–π–∫–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
        httpd.serve_forever()

threading.Thread(target=keep_alive, daemon=True).start()

@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    user_id = str(message.from_user.id)
    user_name = message.from_user.first_name
    user_data[user_id] = {"name": user_name, "crystals": 0, "keys": 0}

    try:
        requests.post(SERVER_URL, json={"id": user_id, "name": user_name})
    except requests.exceptions.RequestException as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä: {e}")

    builder = InlineKeyboardBuilder()
    builder.button(text="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫–∞–Ω–∞–ª", url="https://t.me/holiarus")
    builder.button(text="–ò–≥—Ä–∞—Ç—å –≤ 1 –∫–ª–∏–∫üêµ", url=f"{MENU_URL}?userId={user_id}")
    builder.adjust(1)

    await message.answer(
        f'–ü—Ä–∏–≤–µ—Ç, {user_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Holiarus üêµ.\n\n'
        '–¢–µ–ø–µ—Ä—å —Ç—ã ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–≥–æ –ø—Ä—ã–∂–∫–æ–≤–æ–≥–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è! –ü—Ä—ã–≥–∞–π –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º, –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞–π '
        '–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ –æ—Å–≤–∞–∏–≤–∞–π –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏. –ò–≥—Ä–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –∏ –º—ã –æ—Ü–µ–Ω–∏–º —Ç–≤–æ–∏ —É—Å–ø–µ—Ö–∏ '
        '–≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.\n\n'
        '–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π ‚Äî –≤–º–µ—Å—Ç–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∏—Ç—å—Å—è –µ—â—ë –±–æ–ª—å—à–∏—Ö –≤—ã—Å–æ—Ç!\n\n',
        reply_markup=builder.as_markup(),
        parse_mode="Markdown"
    )

@dp.message(F.text == '/help')
async def help_cmd(message: types.Message):
    await message.answer('–ò–≥—Ä–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –≤–æ–∑–º–æ–∂–Ω—ã —Å–±–æ–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≥–µ–π–º–ø–ª–µ–µ. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ! ü´†')

@dp.message(F.text)
async def unknown_command(message: types.Message):
    await message.answer('–í—ã –≤–≤–µ–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É')

async def main():
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print('–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω')
